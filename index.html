<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CampusConnect (Debug-Link)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        tailwind.config = {
            theme: { extend: { colors: { brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' } } } }
        }
    </script>
    <style>
        #debug-log {
            position: fixed; bottom: 0; left: 0; right: 0; max-height: 200px;
            background: #1a1a1a; color: #00ff00; font-family: monospace;
            font-size: 11px; z-index: 9999; padding: 10px; overflow-y: auto;
            border-top: 2px solid #444; display: none;
        }
        .log-err { color: #ff4444; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #666; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden font-sans text-gray-800">

    <!-- Debug Console (é è¨­éš±è—ï¼ŒæŒ‰æ¨™é¡Œ5ä¸‹é–‹å•Ÿ) -->
    <div id="debug-log">
        <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-1">
            <span>DEBUG CONSOLE</span>
            <button onclick="document.getElementById('debug-log').style.display='none'" class="text-white">CLOSE</button>
        </div>
        <div id="log-content"></div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-brand-50 flex flex-col items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-11/12 max-w-md text-center">
            <h1 id="login-title" class="text-3xl font-bold text-gray-900 mb-2 cursor-pointer">CampusConnect</h1>
            <p class="text-gray-500 mb-8">é€£æ¥æ ¡åœ’ï¼Œå³æ™‚æºé€š</p>
            
            <!-- å˜—è©¦ Aï¼šæ‚¨æ¸¬è©¦æˆåŠŸçš„å½ˆçª—æ¨¡å¼ -->
            <button id="btn-login-popup" class="w-full flex items-center justify-center gap-3 bg-brand-600 text-white font-semibold py-4 px-4 rounded-xl shadow-md mb-4 active:scale-95 transition">
                <i class="fa-brands fa-google text-xl"></i>
                <span>Google ç™»å…¥ (å½ˆçª—æ¨¡å¼)</span>
            </button>
            
            <!-- å˜—è©¦ Bï¼šå‚™ç”¨çš„è·³è½‰æ¨¡å¼ -->
            <button id="btn-login-redirect" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-xl shadow-sm active:scale-95 transition">
                <i class="fa-brands fa-google"></i>
                <span>Google ç™»å…¥ (è·³è½‰å‚™æ¡ˆ)</span>
            </button>

            <div id="login-status" class="mt-6 text-sm font-bold text-brand-600 hidden">
                <i class="fa-solid fa-circle-notch fa-spin mr-2"></i> æ­£åœ¨è™•ç†...
            </div>
            <p class="mt-6 text-xs text-gray-400">è‹¥æŒ‰éˆ•ç„¡åæ‡‰ï¼Œè«‹å¿«é€Ÿé€£é»æ¨™é¡Œã€ŒCampusConnectã€5æ¬¡é–‹å•ŸåµéŒ¯è¦–çª—</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-screen" class="flex h-full hidden w-full relative">
        <!-- Sidebar -->
        <div id="sidebar" class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col h-full z-10 transition-all">
            <div class="p-4 bg-brand-600 text-white flex justify-between items-center shadow-md">
                <div class="flex items-center gap-3">
                    <div id="my-avatar" class="w-10 h-10 rounded-full bg-gray-300 bg-cover border-2 border-white/20"></div>
                    <div class="overflow-hidden">
                        <div id="my-name" class="font-bold text-sm truncate w-32">è¼‰å…¥ä¸­...</div>
                        <div id="my-id" class="text-xs text-brand-200">ID: ...</div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="app.showQRModal()" class="p-2"><i class="fa-solid fa-qrcode"></i></button>
                    <button onclick="auth.signOut()" class="p-2"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
            <div class="flex border-b border-gray-200">
                <button onclick="ui.switchTab('chats')" id="tab-chats" class="flex-1 py-3 text-sm font-bold text-brand-600 border-b-2 border-brand-600">èŠå¤©</button>
                <button onclick="ui.switchTab('contacts')" id="tab-contacts" class="flex-1 py-3 text-sm font-bold text-gray-500">è¯çµ¡äºº</button>
            </div>
            <div class="p-3 bg-gray-50 border-b">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="æœå°‹ Email..." class="w-full pl-9 pr-12 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-brand-500">
                    <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-400"></i>
                    <button id="search-btn" class="absolute right-1 top-1 bg-brand-600 text-white px-3 py-1.5 rounded-md text-xs font-bold">æœå°‹</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto relative">
                <div id="chat-list" class="absolute inset-0 pb-10"></div>
                <div id="contact-list" class="absolute inset-0 hidden"></div>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-area" class="flex-1 flex flex-col bg-gray-100 w-full md:static absolute inset-0 z-20 transform translate-x-full md:translate-x-0 transition-transform duration-300">
            <div class="bg-white p-3 border-b border-gray-200 flex items-center shadow-sm h-16 shrink-0">
                <button onclick="ui.closeChat()" class="md:hidden mr-3 text-gray-600 p-2"><i class="fa-solid fa-arrow-left text-xl"></i></button>
                <img id="header-avatar" src="" class="w-10 h-10 rounded-full bg-gray-200 object-cover">
                <div class="ml-3 flex-1 overflow-hidden">
                    <h3 id="header-title" class="font-bold text-gray-800 truncate"></h3>
                    <div id="header-subtitle" class="text-xs text-gray-500 truncate"></div>
                </div>
            </div>
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
            <div class="bg-white p-3 border-t border-gray-200">
                <form id="message-form" class="flex items-center gap-2">
                    <input type="text" id="message-input" class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm outline-none border-none" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off">
                    <button type="submit" class="bg-brand-600 text-white rounded-full w-10 h-10 flex items-center justify-center shrink-0 shadow-md"><i class="fa-solid fa-paper-plane text-sm"></i></button>
                </form>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm flex flex-col items-center relative">
            <button onclick="document.getElementById('qr-modal').classList.add('hidden')" class="absolute right-4 top-4 text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-xl font-bold mb-6">æˆ‘çš„èº«åˆ† QR Code</h3>
            <div id="qrcode" class="mb-6 p-2 bg-white border rounded-lg"></div>
            <p class="text-xs text-gray-400 text-center">æƒæå¾Œå°‡è‡ªå‹•é–‹å•Ÿç¶²é ä¸¦ç™¼èµ·å°è©±</p>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">æœå°‹çµæœ</h3>
            <div id="search-results" class="space-y-3"></div>
            <button onclick="document.getElementById('search-modal').classList.add('hidden')" class="w-full mt-6 py-2 bg-gray-100 text-gray-600 rounded-lg">é—œé–‰</button>
        </div>
    </div>

    <!-- ================= SCRIPT ================= -->
    <script type="module">
        // --- åµéŒ¯è¼”åŠ© ---
        const logContent = document.getElementById('log-content');
        function dbg(msg, isErr = false) {
            const line = document.createElement('div');
            line.className = isErr ? 'log-err' : '';
            line.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logContent.appendChild(line);
            console.log(msg);
        }

        let clickCount = 0;
        document.getElementById('login-title').onclick = () => {
            clickCount++;
            if(clickCount >= 5) {
                document.getElementById('debug-log').style.display = 'block';
                dbg("Debug Console Opened");
            }
        };

        // --- Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, setDoc, addDoc, doc, getDoc, onSnapshot, serverTimestamp, updateDoc, orderBy, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // TODO: å¡«å…¥æ‚¨çš„ Config
        const firebaseConfig = {
            apiKey: "AIzaSyCRW_kRczHRAnllzoAjF1GSSX_5wCtV_P4",
			authDomain: "campus-im-system.firebaseapp.com",
			projectId: "campus-im-system",
			storageBucket: "campus-im-system.firebasestorage.app",
			messagingSenderId: "47089303225",
			appId: "1:47089303225:web:acdd77342913588e0d2568",
			measurementId: "G-EZD4BF0BWR"
        };

        let auth, db;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            dbg("Firebase Init Success");

            // è™•ç† Redirect å›ä¾†
            getRedirectResult(auth).then((res) => {
                if(res) dbg("Redirect Result: Success " + res.user.email);
            }).catch(e => dbg("Redirect Error: " + e.message, true));

        } catch (e) { dbg("Init Error: " + e.message, true); }

        // --- ç‹€æ…‹ ---
        let currentUser = null;
        let currentChatId = null;
        let unsubscribeMessages = null;

        // --- ç™»å…¥æ§åˆ¶ (ä¿®å¾©æŒ‰éˆ•é»æ“Š) ---
        const provider = new GoogleAuthProvider();

        document.getElementById('btn-login-popup').onclick = () => {
            dbg("User clicked POPUP button");
            document.getElementById('login-status').classList.remove('hidden');
            signInWithPopup(auth, provider)
                .then(() => dbg("Popup request sent"))
                .catch(e => {
                    dbg("Popup blocked/failed: " + e.message, true);
                    alert("å½ˆçª—è¢«å°é–ï¼Œè«‹å˜—è©¦ä¸‹æ–¹çš„è·³è½‰å‚™æ¡ˆ");
                    document.getElementById('login-status').classList.add('hidden');
                });
        };

        document.getElementById('btn-login-redirect').onclick = () => {
            dbg("User clicked REDIRECT button");
            document.getElementById('login-status').classList.remove('hidden');
            signInWithRedirect(auth, provider);
        };

        // --- UI æ“ä½œ ---
        window.ui = {
            switchTab: (tab) => {
                document.getElementById('tab-chats').className = tab === 'chats' ? 'flex-1 py-3 text-sm font-bold text-brand-600 border-b-2 border-brand-600' : 'flex-1 py-3 text-sm font-bold text-gray-500';
                document.getElementById('tab-contacts').className = tab === 'contacts' ? 'flex-1 py-3 text-sm font-bold text-brand-600 border-b-2 border-brand-600' : 'flex-1 py-3 text-sm font-bold text-gray-500';
                document.getElementById('chat-list').classList.toggle('hidden', tab !== 'chats');
                document.getElementById('contact-list').classList.toggle('hidden', tab !== 'contacts');
                if(tab === 'contacts') chatLogic.loadContacts();
            },
            openChat: () => document.getElementById('chat-area').classList.remove('translate-x-full'),
            closeChat: () => {
                currentChatId = null;
                if(unsubscribeMessages) unsubscribeMessages();
                document.getElementById('chat-area').classList.add('translate-x-full');
            },
            scrollToBottom: () => {
                const c = document.getElementById('messages-container');
                c.scrollTop = c.scrollHeight;
            }
        };

        // --- æ ¸å¿ƒé‚è¼¯ ---
        window.app = {
            showQRModal: () => {
                document.getElementById('qrcode').innerHTML = "";
                // ç¶²å€æ ¼å¼å¼·åŒ–
                const baseUrl = window.location.href.split('?')[0];
                const qrUrl = `${baseUrl}?action=add&uid=${currentUser.uid}`;
                dbg("Generating QR for: " + qrUrl);
                new QRCode(document.getElementById("qrcode"), { text: qrUrl, width: 200, height: 200 });
                document.getElementById('qr-modal').classList.remove('hidden');
            },
            handleUrlParams: async () => {
                const params = new URLSearchParams(window.location.search);
                const action = params.get('action');
                const targetUid = params.get('uid');
                dbg(`URL Params detected: action=${action}, uid=${targetUid}`);

                if (action === 'add' && targetUid && currentUser && targetUid !== currentUser.uid) {
                    // æ¸…é™¤ç¶²å€åƒæ•¸é˜²æ­¢é‡è¤‡
                    window.history.replaceState({}, document.title, window.location.pathname);
                    if (confirm("æ˜¯å¦èˆ‡ QR Code æ“æœ‰è€…å»ºç«‹å°è©±ä¸¦åŠ å…¥è¯çµ¡äººï¼Ÿ")) {
                        await window.app.startPrivateChat(targetUid);
                    }
                }
            },
            startPrivateChat: async (targetUid) => {
                dbg("Starting chat with: " + targetUid);
                try {
                    // è‡ªå‹•åŠ è¯çµ¡äºº
                    await updateDoc(doc(db, "users", currentUser.uid), { contacts: arrayUnion(targetUid) });
                    
                    const q = query(collection(db, "chats"), where("type", "==", "private"), where("members", "array-contains", currentUser.uid));
                    const snap = await getDocs(q);
                    let cid = null;
                    snap.forEach(d => { if(d.data().members.includes(targetUid)) cid = d.id; });

                    if(!cid) {
                        const ref = await addDoc(collection(db, "chats"), {
                            type: "private", members: [currentUser.uid, targetUid],
                            updatedAt: serverTimestamp(), lastMessage: "ğŸ‘‹ å·²é€éé€£çµå»ºç«‹å°è©±"
                        });
                        cid = ref.id;
                    }
                    chatLogic.loadChat(cid);
                } catch(e) { dbg("Chat error: " + e.message, true); }
            }
        };

        // --- èŠå¤©åŠŸèƒ½ ---
        const chatLogic = {
            listenToChats: () => {
                const q = query(collection(db, "chats"), where("members", "array-contains", currentUser.uid));
                onSnapshot(q, (snap) => {
                    const list = document.getElementById('chat-list');
                    list.innerHTML = "";
                    let chats = [];
                    snap.forEach(d => chats.push({ id: d.id, ...d.data() }));
                    chats.sort((a,b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));

                    chats.forEach(data => {
                        const div = document.createElement('div');
                        div.className = "p-4 border-b flex items-center gap-3 cursor-pointer hover:bg-gray-50";
                        div.innerHTML = `
                            <div class="w-12 h-12 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 font-bold">å°è©±</div>
                            <div class="flex-1 min-w-0">
                                <div id="t-${data.id}" class="font-bold text-sm truncate">è¼‰å…¥ä¸­...</div>
                                <div class="text-xs text-gray-500 truncate">${data.lastMessage}</div>
                            </div>
                        `;
                        div.onclick = () => chatLogic.loadChat(data.id);
                        list.appendChild(div);

                        if(data.type === 'private') {
                            const other = data.members.find(i => i !== currentUser.uid);
                            getDoc(doc(db, "users", other)).then(s => {
                                if(s.exists()) document.getElementById(`t-${data.id}`).innerText = s.data().displayName;
                            });
                        } else {
                            document.getElementById(`t-${data.id}`).innerText = data.groupName;
                        }
                    });
                });
            },
            loadContacts: async () => {
                const snap = await getDoc(doc(db, "users", currentUser.uid));
                const list = document.getElementById('contact-list');
                list.innerHTML = "";
                const ids = snap.data().contacts || [];
                for(const id of ids) {
                    const us = await getDoc(doc(db, "users", id));
                    if(us.exists()) {
                        const u = us.data();
                        const div = document.createElement('div');
                        div.className = "p-4 border-b flex items-center justify-between";
                        div.innerHTML = `<div class="font-bold text-sm">${u.displayName}</div><button class="text-brand-600"><i class="fa-solid fa-comment"></i></button>`;
                        div.onclick = () => window.app.startPrivateChat(id);
                        list.appendChild(div);
                    }
                }
            },
            loadChat: async (id) => {
                currentChatId = id;
                ui.openChat();
                dbg("Loading chat: " + id);
                const cSnap = await getDoc(doc(db, "chats", id));
                const data = cSnap.data();
                document.getElementById('header-title').innerText = data.groupName || "ç§èŠ";
                
                if(unsubscribeMessages) unsubscribeMessages();
                const q = query(collection(db, "chats", id, "messages"), orderBy("timestamp", "asc"));
                unsubscribeMessages = onSnapshot(q, (snap) => {
                    const cont = document.getElementById('messages-container');
                    cont.innerHTML = "";
                    snap.forEach(d => {
                        const m = d.data();
                        const isMe = m.senderId === currentUser.uid;
                        const div = document.createElement('div');
                        div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
                        div.innerHTML = `<div class="${isMe ? 'bg-brand-600 text-white' : 'bg-white'} px-4 py-2 rounded-xl text-sm shadow-sm max-w-[80%]">${m.text}</div>`;
                        cont.appendChild(div);
                    });
                    ui.scrollToBottom();
                });
            }
        };

        // --- äº‹ä»¶ ---
        document.getElementById('search-btn').onclick = async () => {
            const val = document.getElementById('search-input').value;
            const res = document.getElementById('search-results');
            res.innerHTML = "æœå°‹ä¸­...";
            document.getElementById('search-modal').classList.remove('hidden');
            const q = query(collection(db, "users"), where("email", "==", val));
            const snap = await getDocs(q);
            res.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                const div = document.createElement('div');
                div.className = "p-3 border rounded flex justify-between items-center";
                div.innerHTML = `<span>${u.displayName}</span><button class="bg-brand-600 text-white px-3 py-1 rounded">å°è©±</button>`;
                div.querySelector('button').onclick = () => window.app.startPrivateChat(u.uid);
                res.appendChild(div);
            });
        };

        document.getElementById('message-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            if(!input.value || !currentChatId) return;
            const t = input.value; input.value = "";
            await addDoc(collection(db, "chats", currentChatId, "messages"), {
                text: t, senderId: currentUser.uid, timestamp: serverTimestamp()
            });
            await updateDoc(doc(db, "chats", currentChatId), { lastMessage: t, updatedAt: serverTimestamp() });
        };

        // --- ç‹€æ…‹ç›£è½ ---
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                dbg("Auth State: Logged In as " + u.email);
                currentUser = u;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                document.getElementById('my-avatar').style.backgroundImage = `url(${u.photoURL})`;
                document.getElementById('my-name').innerText = u.displayName;

                const userRef = doc(db, "users", u.uid);
                const uSnap = await getDoc(userRef);
                if(!uSnap.exists()) {
                    await setDoc(userRef, {
                        uid: u.uid, email: u.email, displayName: u.displayName, photoURL: u.photoURL,
                        studentId: Math.floor(100000 + Math.random() * 900000).toString(),
                        createdAt: serverTimestamp(), contacts: []
                    });
                } else {
                    document.getElementById('my-id').innerText = "ID: " + uSnap.data().studentId;
                }
                chatLogic.listenToChats();
                window.app.handleUrlParams();
            } else {
                dbg("Auth State: Logged Out");
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('login-status').classList.add('hidden');
            }
        });

    </script>
</body>
</html>