<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CampusConnect (Debug Mode)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' } } }
            }
        }
    </script>
    <style>
        /* 除錯視窗樣式 */
        #debug-console {
            position: fixed; top: 0; left: 0; right: 0; height: 150px;
            background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace;
            font-size: 10px; overflow-y: scroll; z-index: 9999; padding: 5px;
            pointer-events: none; /* 讓點擊穿透 */
            display: none; /* 預設隱藏，有錯誤時開啟 */
        }
        .log-line { border-bottom: 1px solid #333; padding: 2px 0; }
        .log-error { color: #ff5555; font-weight: bold; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden font-sans text-gray-800">

    <!-- Debug Console -->
    <div id="debug-console"></div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-brand-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-11/12 max-w-md text-center">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">CampusConnect</h1>
            
            <!-- 增加：強制 Popup 模式按鈕 (備用方案) -->
            <button id="google-login-btn-popup" class="w-full flex items-center justify-center gap-3 bg-brand-600 text-white font-semibold py-3 px-4 rounded-lg shadow-sm mb-3">
                <i class="fa-brands fa-google"></i> Google 登入 (彈窗模式)
            </button>
            
            <!-- 增加：強制 Redirect 模式按鈕 -->
            <button id="google-login-btn-redirect" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg shadow-sm">
                <i class="fa-brands fa-google"></i> Google 登入 (跳轉模式)
            </button>

            <div id="login-loading" class="hidden mt-4 text-brand-600 font-bold">
                <i class="fa-solid fa-circle-notch fa-spin mr-2"></i> 處理中...請稍候
            </div>
            
            <p class="mt-4 text-xs text-gray-400">若上方按鈕無反應，請截圖頂部的黑色代碼視窗</p>
        </div>
    </div>

    <!-- Main App (維持原樣，略過重複部分以節省篇幅，核心邏輯在下方 Script) -->
    <div id="app-screen" class="flex h-full hidden w-full relative">
        <div id="sidebar" class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col h-full z-10">
            <div class="p-4 bg-brand-600 text-white flex justify-between items-center shadow-md shrink-0">
                <div class="flex items-center gap-3 cursor-pointer">
                    <div id="my-avatar" class="w-10 h-10 rounded-full bg-gray-300 bg-cover"></div>
                    <div><div id="my-name" class="font-bold text-sm truncate w-32"></div></div>
                </div>
                <button onclick="auth.signOut()"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
            <!-- 簡化的列表 (用於測試登入) -->
            <div class="flex-1 flex items-center justify-center text-gray-400 p-4 text-center">
                登入成功！<br>這是偵錯模式，請確認手機是否能看到此畫面。
            </div>
        </div>
    </div>

    <!-- ================= LOGIC ================= -->
    <script type="module">
        // 1. 攔截 Console Log 顯示在螢幕上
        const debugConsole = document.getElementById('debug-console');
        function logToScreen(msg, type = 'info') {
            debugConsole.style.display = 'block';
            const div = document.createElement('div');
            div.className = `log-line ${type === 'error' ? 'log-error' : ''}`;
            div.innerText = `[${type.toUpperCase()}] ${msg}`;
            debugConsole.appendChild(div);
            debugConsole.scrollTop = debugConsole.scrollHeight;
            console.log(msg);
        }
        window.onerror = function(message, source, lineno, colno, error) {
            logToScreen(`${message} (${source}:${lineno})`, 'error');
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ================= CONFIGURATION =================
        // TODO: 請務必重新填入您的 Config
        const firebaseConfig = {
            apiKey: "AIzaSyCRW_kRczHRAnllzoAjF1GSSX_5wCtV_P4",
			authDomain: "campus-im-system.firebaseapp.com",
			projectId: "campus-im-system",
			storageBucket: "campus-im-system.firebasestorage.app",
			messagingSenderId: "47089303225",
			appId: "1:47089303225:web:acdd77342913588e0d2568",
			measurementId: "G-EZD4BF0BWR"
        };

        let app, auth, db;
        try {
            logToScreen("初始化 Firebase...");
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            logToScreen("Firebase 初始化成功");

            // 處理 Redirect 結果 (手機跳轉回來後會觸發這裡)
            getRedirectResult(auth)
                .then((result) => {
                    if (result) {
                        logToScreen("Redirect 登入成功！User: " + result.user.email);
                    } else {
                        logToScreen("Redirect 無回傳結果 (可能是初次載入)");
                    }
                }).catch((error) => {
                    logToScreen("Redirect 錯誤: " + error.message, 'error');
                    alert("登入錯誤: " + error.message);
                    document.getElementById('login-loading').classList.add('hidden');
                });

        } catch (e) {
            logToScreen("Config 錯誤: " + e.message, 'error');
            alert("Firebase Config 錯誤，請檢查程式碼");
        }

        // 登入邏輯
        const provider = new GoogleAuthProvider();

        // 方式 A: 彈窗 (電腦/部分手機適用)
        document.getElementById('google-login-btn-popup').addEventListener('click', () => {
            logToScreen("使用者點擊：Popup 登入");
            document.getElementById('login-loading').classList.remove('hidden');
            signInWithPopup(auth, provider)
                .then(() => logToScreen("Popup 流程完成"))
                .catch((error) => {
                    document.getElementById('login-loading').classList.add('hidden');
                    logToScreen("Popup 失敗: " + error.message + " | code: " + error.code, 'error');
                    alert("Popup 失敗: " + error.message);
                });
        });

        // 方式 B: 跳轉 (手機標準做法)
        document.getElementById('google-login-btn-redirect').addEventListener('click', () => {
            logToScreen("使用者點擊：Redirect 登入");
            document.getElementById('login-loading').classList.remove('hidden');
            // 在跳轉前記錄，確保不是因為點擊沒反應
            setTimeout(() => {
                signInWithRedirect(auth, provider)
                    .then(() => logToScreen("Redirect 指令已發出 (頁面應跳轉)"))
                    .catch((error) => {
                        document.getElementById('login-loading').classList.add('hidden');
                        logToScreen("Redirect 啟動失敗: " + error.message, 'error');
                        alert("Redirect 失敗: " + error.message);
                    });
            }, 100);
        });

        // 監聽狀態
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                logToScreen("偵測到使用者已登入: " + u.email);
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                document.getElementById('my-avatar').style.backgroundImage = `url(${u.photoURL})`;
                document.getElementById('my-name').innerText = u.displayName;

                // 簡單寫入資料庫測試權限
                try {
                    const userRef = doc(db, "users", u.uid);
                    const uSnap = await getDoc(userRef);
                    if(!uSnap.exists()) {
                         await setDoc(userRef, {
                            uid: u.uid, email: u.email, displayName: u.displayName, photoURL: u.photoURL,
                            studentId: Math.floor(100000 + Math.random() * 900000).toString(),
                            createdAt: serverTimestamp(), contacts: []
                        });
                        logToScreen("新使用者資料建立成功");
                    }
                } catch(dbErr) {
                    logToScreen("資料庫寫入失敗 (可能是權限問題): " + dbErr.message, 'error');
                }

            } else {
                logToScreen("目前為未登入狀態");
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('login-loading').classList.add('hidden');
            }
        });

        window.auth = auth;
    </script>
</body>
</html>